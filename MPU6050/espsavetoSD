#include <FS.h>
#include <SD.h>
#include <SPI.h>
#include <Wire.h>
#include "MPU6050.h"

MPU6050 mpu;
File logfile;

#define SD_CS 5

// ---- BUFFER ----
const int BUFFER_SIZE = 2000;     // 2000 samples per block (~2 seconds at 1 kHz)
String buffer[BUFFER_SIZE];
volatile int buf_index = 0;

// =============================================================
//               1 KHZ SAMPLING TASK (ISR)
// =============================================================
void IRAM_ATTR samplingTask(void *arg) {
    int16_t ax, ay, az, gx, gy, gz;
    mpu.getMotion6(&ax, &ay, &az, &gx, &gy, &gz);

    float AccX = ax / 16384.0;
    float AccY = ay / 16384.0;
    float AccZ = az / 16384.0;
    
    float GyroX = gx / 131.0;
    float GyroY = gy / 131.0;
    float GyroZ = gz / 131.0;

    int64_t t = esp_timer_get_time();

    if (buf_index < BUFFER_SIZE) {
        buffer[buf_index] =
            String(t) + "," +
            String(AccX) + "," +
            String(AccY) + "," +
            String(AccZ) + "," +
            String(GyroX) + "," +
            String(GyroY) + "," +
            String(GyroZ);

        buf_index = buf_index + 1;   // avoids volatile++ warning
    }
}

// =============================================================
//                           SETUP
// =============================================================
void setup() {
    Serial.begin(115200);
    delay(500);

    // ---- I2C SETUP ----
    Wire.begin(21, 22);
    Wire.setClock(400000);

    // ---- MPU6050 INIT ----
    mpu.initialize();
    if (!mpu.testConnection()) {
        Serial.println("MPU6050 not found!");
        while (1);
    }

    // 1 kHz internal sample rate
    mpu.setRate(0);  // 8 kHz / (1 + 0) = 8 kHz gyroscope internal
                     // Accelerometer updates at 1 kHz

    // ---- SD CARD SETUP ----
    if (!SD.begin(SD_CS)) {
        Serial.println("SD init failed!");
        while (1);
    }

    logfile = SD.open("/data.csv", FILE_APPEND);
    if (!logfile) {
        Serial.println("File open failed!");
        while (1);
    }

    // Add CSV header if file is empty
    if (logfile.size() == 0) {
        logfile.println("timestamp_us,AccX,AccY,AccZ,GyroX,GyroY,GyroZ");
        logfile.flush();
    }

    // ---- START 1 KHZ TIMER ----
    const esp_timer_create_args_t periodic_timer_args = {
        .callback = &samplingTask,
        .arg = NULL,
        .dispatch_method = ESP_TIMER_TASK,
        .name = "sampling"
    };

    esp_timer_handle_t periodic_timer;
    esp_timer_create(&periodic_timer_args, &periodic_timer);

    // 1000 Âµs = 1 sample per ms = 1 kHz
    esp_timer_start_periodic(periodic_timer, 1000);

    Serial.println("Sampling started at 1 kHz...");
}

// =============================================================
//                           LOOP
// =============================================================
void loop() {
    // When buffer fills, write block to SD card
    if (buf_index >= BUFFER_SIZE) {
        Serial.println("Writing 2000 samples...");
        for (int i = 0; i < BUFFER_SIZE; i++) {
            logfile.println(buffer[i]);
        }
        logfile.flush();         // optional, but safer
        buf_index = 0;
    }
}
